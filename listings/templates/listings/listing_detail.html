<!-- listings/listing_detail.html -->

{% extends 'accounts/base.html' %}
{% block content %}
<h1>{{ listing.item_name }}</h1>
<img src="{{ listing.image.url }}" alt="{{ listing.item_name }}">
<p>Description: {{ listing.description }}</p>
<p>Quantity: {{ listing.quantity }}</p>
<p>Expiration Date: {{ listing.expiration_date }}</p>
{% if user.is_authenticated %}
    {% if user != listing.user %}
        {% if not has_sent_request %}
            <form method="post" action="{% url 'send_exchange_request' listing.id %}">
                {% csrf_token %}
                <button type="submit">Send Exchange Request</button>
            </form>
        {% else %}
            <p class="error">You have already sent a request for this item.</p>
        {% endif %}
    {% endif %}
    {% if user == listing.user %}
        <a href="{% url 'listing_update' listing.id %}">Update</a>
        <form method="post" action="{% url 'listing_delete' listing.id %}">
            {% csrf_token %}
            <button type="submit">Delete</button>
        </form>
    {% endif %}
{% endif %}
<!-- Display exchange requests -->
<h2>Exchange Requests</h2>
<ul>
    {% for request in exchange_requests %}
    <li>
        <p>From: {% if request.sender == request.listing.user %}Myself{% else %}{{ request.sender.username }}{% endif %}</p>
        <p>Status: 
            {% if request.status == 'Accepted' %}
                <span class="accepted">Accepted</span>
            {% elif request.status == 'Rejected' %}
                <span class="rejected">Rejected</span>
            {% else %}
                Pending
            {% endif %}
        </p>
        <p>Message: {{ request.message }}</p>
        {% if user == listing.user %}
            <form method="post" action="{% url 'manage_exchange_requests' listing.id %}">
                {% csrf_token %}
                <input type="hidden" name="request_id" value="{{ request.id }}">
                <button type="submit" name="action" value="accept">Accept</button>
                <button type="submit" name="action" value="reject">Reject</button>
                <button type="submit" name="action" value="message">Message</button>
            </form>
        {% endif %}
        {% if user == request.sender %}
            <form method="post" action="{% url 'cancel_exchange_request' listing.id request.id %}">
                {% csrf_token %}
                <button type="submit">Cancel Request</button>
            </form>
        {% endif %}
    </li>
    {% empty %}
    <li>No exchange requests yet.</li>
    {% endfor %}
</ul>
{% endblock %}
